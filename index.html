<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MediaPipe Web 手势识别示例</title>
    <style>
        body { font-family: Arial, sans-serif; display: flex; flex-direction: column; align-items: center; margin-top: 20px; }
        video { border: 2px solid #333; transform: scaleX(-1); /* 镜像翻转 */ }
        .controls { margin-top: 15px; }
        #liveView { position: relative; width: 640px; height: 480px; }
        canvas { position: absolute; top: 0; left: 0; transform: scaleX(-1); /* 镜像翻转 */ }
        #gestureResult { margin-top: 20px; font-size: 1.2em; font-weight: bold; color: #007bff; }
        .loading { color: gray; }
    </style>
</head>
<body>
    <h1>MediaPipe Web 手势识别</h1>

    <div class="controls">
        <button id="startButton">启动摄像头并开始识别</button>
        <p id="loadingMessage" class="loading">正在加载模型，请稍候...</p>
    </div>

    <div id="liveView" style="display: none;">
        <video id="webcam" autoplay playsinline width="640px" height="480px"></video>
        <canvas id="outputCanvas" width="640px" height="480px"></canvas>
    </div>

    <div id="gestureResult">
        当前手势: <span id="currentGesture">等待识别...</span>
    </div>

    <script type="module">
        import { GestureRecognizer, FilesetResolver, DrawingUtils } from "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@latest";

        const video = document.getElementById("webcam");
        const liveView = document.getElementById("liveView");
        const startButton = document.getElementById("startButton");
        const currentGestureSpan = document.getElementById("currentGesture");
        const loadingMessage = document.getElementById("loadingMessage");
        const canvasElement = document.getElementById("outputCanvas");
        const canvasCtx = canvasElement.getContext("2d");
        const drawingUtils = new DrawingUtils(canvasCtx);

        let gestureRecognizer;
        let runningMode = "VIDEO"; // 或者 "IMAGE"
        let enableWebcam = false;

        // --- 初始化手势识别器 ---
        const createGestureRecognizer = async () => {
            const vision = await FilesetResolver.forVisionTasks(
                "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@latest/wasm"
            );
            gestureRecognizer = await GestureRecognizer.createFromOptions(vision, {
                baseOptions: {
                    modelAssetPath: "https://storage.googleapis.com/mediapipe-models/gesture_recognizer/gesture_recognizer/float16/1/gesture_recognizer.task",
                    delegate: "GPU" // 尝试使用GPU加速，如果不支持会回退到CPU
                },
                runningMode: runningMode,
                numHands: 2 // 最多识别两只手
            });
            console.log("手势识别器初始化完成！");
            loadingMessage.style.display = 'none'; // 隐藏加载消息
            startButton.disabled = false; // 启用开始按钮
        };

        createGestureRecognizer();

        // --- 启动摄像头和识别 ---
        startButton.addEventListener("click", () => {
            if (enableWebcam) {
                // 如果已经启动了，再次点击可以停止（这里没有实现停止逻辑，只是示例）
                return;
            }
            if (!gestureRecognizer) {
                console.log("手势识别器尚未加载完成，请稍候！");
                return;
            }

            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                navigator.mediaDevices.getUserMedia({ video: true })
                    .then(function (stream) {
                        video.srcObject = stream;
                        video.addEventListener("loadeddata", predictWebcam);
                        liveView.style.display = 'block'; // 显示视频和画布
                        startButton.style.display = 'none'; // 隐藏开始按钮
                        enableWebcam = true;
                    })
                    .catch(function (err) {
                        console.error("无法访问摄像头: " + err);
                        currentGestureSpan.textContent = "无法访问摄像头，请检查权限。";
                    });
            } else {
                console.error("浏览器不支持 getUserMedia");
                currentGestureSpan.textContent = "你的浏览器不支持摄像头访问。";
            }
        });

        // --- 实时预测 ---
        let lastVideoTime = -1;
        async function predictWebcam() {
            // 清空画布
            canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);

            // 仅在视频帧更新时进行处理
            if (video.currentTime !== lastVideoTime) {
                lastVideoTime = video.currentTime;

                const results = gestureRecognizer.recognizeForVideo(video, performance.now());

                if (results.landmarks) {
                    for (const landmarks of results.landmarks) {
                        drawingUtils.drawConnectors(landmarks, GestureRecognizer.HAND_CONNECTIONS, { color: "#00FF00", lineWidth: 5 });
                        drawingUtils.drawLandmarks(landmarks, { color: "#FF0000", lineWidth: 2 });
                    }
                }

                if (results.gestures.length > 0) {
                    const topGesture = results.gestures[0][0]; // 获取置信度最高的手势
                    currentGestureSpan.textContent = `${topGesture.categoryName} (置信度: ${Math.round(topGesture.score * 100)}%)`;
                } else {
                    currentGestureSpan.textContent = "未识别到手势";
                }
            }

            // 循环调用自身，实现实时处理
            if (enableWebcam) {
                window.requestAnimationFrame(predictWebcam);
            }
        }
    </script>
</body>
</html>
